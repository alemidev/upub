#!/bin/bash

echo "building release binary"
cargo build --release --all-features
echo "stopping service"
systemctl --user stop upub
echo "installing new binary"
cp ./target/release/upub /opt/bin/upub
echo "migrating database"
/opt/bin/upub -c /srv/tci/upub.toml --domain https://upub.alemi.dev migrate
echo "restarting service"
systemctl --user start upub
echo "rebuilding frontend"
cd web
/opt/bin/trunk build --release --public-url 'https://upub.alemi.dev/web'
echo "deploying frontend"
rm /srv/http/upub/web/*
mv ./dist/* /srv/http/upub/web/
echo "done"
