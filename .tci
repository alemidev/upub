#!/bin/bash

echo "building release binary"
cargo build --release --all-features
echo "stopping service"
systemctl --user stop upub
echo "installing new binary"
cp ./target/release/upub /opt/bin/upub
echo "rebuilding database"
DB="/srv/tci/upub.db"
cp "$DB" "$DB.bak"
rm "$DB"
touch "$DB"
/opt/bin/upub --db "sqlite://$DB" --domain https://feditest.alemi.dev migrate
/opt/bin/upub --db "sqlite://$DB" --domain https://feditest.alemi.dev faker
echo "restarting service"
systemctl --user start upub
echo "done"
